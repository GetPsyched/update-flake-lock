{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import * as actionsCore from \"@actions/core\";\nimport * as actionsExec from \"@actions/exec\";\nimport * as actionsGithub from \"@actions/github\";\nimport { readFileSync } from \"fs\";\n\nasync function getSigningInfo() {\n  if (actionsCore.getBooleanInput(\"sign-commits\")) {\n    // Import bot's GPG key for signing commits\n    const gpgPrivateKey = actionsCore.getInput(\"gpg-private-key\");\n    const gpgFingerprint = actionsCore.getInput(\"gpg-fingerprint\");\n    const gpgPassphrase = actionsCore.getInput(\"gpg-passphrase\");\n    const git_config_global = true;\n    const git_user_signingkey = true;\n    const git_commit_gpgsign = true;\n\n    // FIXME: Figure out how to do gpg stuff\n    const gpgOutputs = await actionsExec.getExecOutput(\"some command here\");\n\n    return {\n      author: { name: \"\", email: \"\" },\n      committer: { name: \"\", email: \"\" },\n    };\n  } else {\n    return {\n      author: {\n        name: actionsCore.getInput(\"git-author-name\"),\n        email: actionsCore.getInput(\"git-author-email\"),\n      },\n      committer: {\n        name: actionsCore.getInput(\"git-committer-name\"),\n        email: actionsCore.getInput(\"git-committer-email\"),\n      },\n    };\n  }\n}\n\nasync function createBranch(token: string, base: string, head: string) {\n  const octokit = actionsGithub.getOctokit(token);\n\n  const repoDetails = await octokit.rest.repos.get({\n    ...actionsGithub.context.repo,\n  });\n  const baseBranch = base ? base : repoDetails.data.default_branch;\n\n  const branches = await octokit.rest.repos.listBranches({\n    ...actionsGithub.context.repo,\n  });\n  if (!branches.data.some((branch) => branch.name === head)) {\n    const baseBranchRef = await octokit.rest.git.getRef({\n      ...actionsGithub.context.repo,\n      ref: `heads/${baseBranch}`,\n    });\n\n    await octokit.rest.git.createRef({\n      ...actionsGithub.context.repo,\n      ref: `refs/heads/${head}`,\n      sha: baseBranchRef.data.object.sha,\n    });\n  }\n\n  return [baseBranch, head];\n}\n\nasync function updateFlakeLock(options?: {\n  inputs?: string[];\n  nixOptions?: string[];\n  workingDirectory?: string;\n}) {\n  // Run update-flake-lock.sh\n  // await actionsExec.exec(\"./update-flake-lock.sh\", [], {\n  //   env: {\n  //     COMMIT_MSG: actionsCore.getInput(\"commit-msg\"),\n  //     GIT_AUTHOR_NAME: authorName,\n  //     GIT_AUTHOR_EMAIL: authorEmail,\n  //     GIT_COMMITTER_NAME: committerName,\n  //     GIT_COMMITTER_EMAIL: committerEmail,\n  //     // Explicitly specify Nix path since it's not automatically picked up.\n  //     NIX_BINARY: await actionsIo.which(\"nix\", true),\n  //     NIX_OPTIONS: actionsCore.getInput(\"nix-options\"),\n  //     PATH_TO_FLAKE_DIR: actionsCore.getInput(\"path-to-flake-dir\"),\n  //     TARGETS: actionsCore.getInput(\"inputs\"),\n  //   },\n  // });\n  const flakeUpdatesWithWarning = (\n    await actionsExec.getExecOutput(\n      \"nix flake update\",\n      [\n        \"--no-warn-dirty\",\n        // FIXME: `--update-input` is not a recognised flag\n        //  ...inputs.map((input) => `--update-input ${input}`)\n      ],\n      { cwd: options?.workingDirectory },\n    )\n  ).stderr;\n  if (!flakeUpdatesWithWarning) return \"\";\n\n  const [warning, ...flakeUpdates] = flakeUpdatesWithWarning.split(\"\\n\");\n  return [\"Flake lock file updates:\", \"\", ...flakeUpdates].join(\"\\n\").trim();\n}\n\nasync function commit(\n  token: string,\n  headBranch: string,\n  message: string,\n  pathToFlakeDir: string,\n) {\n  const octokit = actionsGithub.getOctokit(token);\n\n  const blob = await octokit.rest.git.createBlob({\n    ...actionsGithub.context.repo,\n    content: Buffer.from(\n      readFileSync(`${pathToFlakeDir}flake.lock`, \"utf-8\"),\n    ).toString(\"base64\"),\n    encoding: \"base64\",\n  });\n\n  const currentCommit = await octokit.rest.repos.getCommit({\n    ...actionsGithub.context.repo,\n    ref: `heads/${headBranch}`,\n  });\n\n  const tree = await octokit.rest.git.createTree({\n    ...actionsGithub.context.repo,\n    base_tree: currentCommit.data.commit.tree.sha,\n    tree: [\n      {\n        path: `${pathToFlakeDir}flake.lock`,\n        mode: \"100644\",\n        type: \"blob\",\n        sha: blob.data.sha,\n      },\n    ],\n  });\n\n  if (tree.data.sha === currentCommit.data.commit.tree.sha) {\n    console.log(\"Working tree is clean, skipping commit.\");\n    return \"\";\n  }\n\n  const newCommit = await octokit.rest.git.createCommit({\n    ...actionsGithub.context.repo,\n    ...(await getSigningInfo()),\n    message: message,\n    tree: tree.data.sha,\n    parents: [currentCommit.data.sha],\n  });\n\n  await octokit.rest.git.updateRef({\n    ...actionsGithub.context.repo,\n    ref: `heads/${headBranch}`,\n    sha: newCommit.data.sha,\n    force: true,\n  });\n\n  // // Set additional env variables (GIT_COMMIT_MESSAGE)\n  // const delimiter = (\n  //   await actionsExec.getExecOutput(\"base64\", [], {\n  //     input: Buffer.from(\n  //       (\n  //         await actionsExec.getExecOutput(\n  //           \"dd if=/dev/urandom bs=15 count=1 status=none\",\n  //         )\n  //       ).stdout,\n  //     ),\n  //   })\n  // ).stdout;\n  // const commitMessage = (\n  //   await actionsExec.getExecOutput(\"git log --format=%b -n 1\")\n  // ).stdout;\n  // // TODO: GITHUB_ENV insertions\n  // // echo \"GIT_COMMIT_MESSAGE<<$DELIMITER\" >> $GITHUB_ENV\n  // // echo \"$COMMIT_MESSAGE\" >> $GITHUB_ENV\n  // // echo \"$DELIMITER\" >> $GITHUB_ENV\n  // console.log(\"GIT_COMMIT_MESSAGE is:\", commitMessage);\n}\n\nasync function createPR(\n  token: string,\n  baseBranch: string,\n  headBranch: string,\n  meta: {\n    title: string;\n    body: string;\n    labels?: string[];\n    reviewers?: string[];\n    assignees?: string[];\n  },\n) {\n  const octokit = actionsGithub.getOctokit(token);\n  const existingPR = await octokit.rest.pulls.list({\n    ...actionsGithub.context.repo,\n    head: headBranch,\n  });\n  if (existingPR.data.length !== 0) {\n    console.log(\n      `Skipping PR creation, it already exists at ${existingPR.data[0].html_url}`,\n    );\n    return;\n  }\n  const pullRequest = await octokit.rest.pulls.create({\n    ...actionsGithub.context.repo,\n    base: baseBranch,\n    head: headBranch,\n\n    title: meta.title,\n    body: meta.body,\n\n    // FIXME: Figure out how to add the following missing attributes:\n    //   - delete-branch\n    //   - committer\n    //   - author\n  });\n\n  if (meta.labels) {\n    await octokit.rest.issues.addLabels({\n      ...actionsGithub.context.repo,\n      issue_number: pullRequest.data.number,\n      labels: meta.labels,\n    });\n  }\n\n  if (meta.reviewers) {\n    await octokit.rest.pulls.requestReviewers({\n      ...actionsGithub.context.repo,\n      pull_number: pullRequest.data.number,\n      reviewers: meta.reviewers,\n    });\n  }\n\n  if (meta.assignees) {\n    await octokit.rest.issues.addAssignees({\n      ...actionsGithub.context.repo,\n      issue_number: pullRequest.data.number,\n      assignees: meta.assignees,\n    });\n  }\n}\n\nasync function main() {\n  const token = actionsCore.getInput(\"token\");\n  const [baseBranch, headBranch] = await createBranch(\n    token,\n    actionsCore.getInput(\"base\"),\n    actionsCore.getInput(\"branch\"),\n  );\n\n  const pathToFlakeDir = actionsCore.getInput(\"path-to-flake-dir\");\n  const flakeChangelog = await updateFlakeLock({\n    inputs: actionsCore\n      .getInput(\"inputs\")\n      .split(\" \")\n      .filter((input) => !!input),\n    nixOptions: actionsCore\n      .getInput(\"nix-options\")\n      .split(\" \")\n      .filter((input) => !!input),\n    workingDirectory: pathToFlakeDir,\n  });\n  if (!flakeChangelog) return;\n\n  await commit(\n    token,\n    headBranch,\n    `${actionsCore.getInput(\"commit-msg\")}\\n\\n${flakeChangelog}`,\n    pathToFlakeDir,\n  );\n\n  await createPR(token, baseBranch, headBranch, {\n    title: actionsCore.getInput(\"pr-title\"),\n    body: actionsCore\n      .getInput(\"pr-body\")\n      // FIXME: Figure out why GH isn't replacing env vars with their values\n      .replace(\"{{ env.GIT_COMMIT_MESSAGE }}\", flakeChangelog),\n    labels: actionsCore\n      .getInput(\"pr-labels\")\n      .split(\",\")\n      .flatMap((label) => label.split(\"\\n\"))\n      .filter((label) => !!label),\n    reviewers: actionsCore\n      .getInput(\"pr-reviewers\")\n      .split(\",\")\n      .flatMap((label) => label.split(\"\\n\"))\n      .filter((label) => !!label),\n    assignees: actionsCore\n      .getInput(\"pr-assignees\")\n      .split(\",\")\n      .flatMap((label) => label.split(\"\\n\"))\n      .filter((label) => !!label),\n  });\n}\n\nmain();\n"],"mappings":"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","names":[]}